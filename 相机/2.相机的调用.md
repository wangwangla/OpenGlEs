## 相机的调用

这一讲我们来使用相机来进行预览，并且进行相机的翻转（前置和后置）。

### 加权限

```java
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
```

请求权限检查权限

```java
PermissionUtils.requestPermissions(this, new String[] {
        Manifest.permission.CAMERA,
}, 0);
```

检查权限

```java
if (PermissionUtils.permissionsChecking(
        this,
        new String[] {
                Manifest.permission.CAMERA
        })) {
```

权限工具方法，不知道在哪里复制来的

```java
public class PermissionUtils {
    /**
     * 请求权限列表
     * @param activity
     * @param permissions
     */
    public static void requestPermissions(@NonNull FragmentActivity activity, @NonNull String[] permissions, int request_code) {
        boolean hasPermissions = permissionsChecking(activity, permissions);
        if (!hasPermissions) {
            ActivityCompat.requestPermissions(activity, permissions, request_code);
        }
    }

    /**
     * 检查权限列表是否授权
     * @param context
     * @param permissions
     * @return
     */
    public static boolean permissionsChecking(@NonNull Context context, @NonNull String[] permissions) {
        int targetVersion = 1;
        try {
            final PackageInfo info = context.getPackageManager()
                    .getPackageInfo(context.getPackageName(), 0);
            targetVersion = info.applicationInfo.targetSdkVersion;
        } catch (PackageManager.NameNotFoundException e) {

        }

        boolean result = true;
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M
                && targetVersion >= Build.VERSION_CODES.M) {
            for (int i = 0; i < permissions.length; i++) {
                result = (ContextCompat.checkSelfPermission(context, permissions[i])
                        == PackageManager.PERMISSION_GRANTED);
                if (!result) {
                    break;
                }
            }
        } else {
            for (int i = 0; i < permissions.length; i++) {
                result = (PermissionChecker.checkSelfPermission(context, permissions[i])
                        == PermissionChecker.PERMISSION_GRANTED);
                if (!result) {
                    break;
                }
            }
        }
        return result;
    }
}
```



### 全屏显示

```java
getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
getWindow().clearFlags(WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN);
```

###  surfaceView显示

之前说过，如果使用surfaceView进行显示，需要设置生命周期函数，设置回调。

```kava
SurfaceHolder mHolder = getHolder();
mHolder.addCallback(this);
```

## 相机相关的

初始化相机。

1、了解一下常量

```java
/**
 * The facing of the camera is opposite to that of the screen.
 */
public static final int CAMERA_FACING_BACK = 0;

/**
 * The facing of the camera is the same as that of the screen.
 */
public static final int CAMERA_FACING_FRONT = 1;
```

前置和后置摄像头。

2.根据参数打开相机

```java
Camera.open(mCameraId0);
```

3.获取数据

```java
Camera.Parameters parameters = mCamera.getParameters();
if (parameters.getSupportedFocusModes().contains(
        Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE)) {
    parameters.setFocusMode(Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE);
}
```

4.设置预览尺寸，防止尺寸发生拉伸现象。

```
List<Camera.Size> sizes1 = parameters.getSupportedPreviewSizes(); //得到的比例，宽是大头
int[] result1 = getOptimalSize(sizes1, surfaceView.getWidth(), surfaceView.getHeight());
parameters.setPreviewSize(result1[0], result1[1]);
fitWidth = result1[0];
fitHeight = result1[1];
```

getOptionmalsize

```java
/**
 * *找出最接近的尺寸，以保证图像不会被拉伸
 * @param sizes
 * @param currentWidth
 * @param currentHeight
 * @return
 */
private int[] getOptimalSize(List<Camera.Size> sizes, int currentWidth, int currentHeight) {
    int i = 1;
    //大头
    int bestWidth = sizes.get(0).width;
    //小头
    int bestHeight = sizes.get(0).height;
    //很重要，第一项一定是高/宽
    float min = Math.abs((float) bestHeight / (float) bestWidth - (float) currentWidth / (float) currentHeight);
    while (i < sizes.size()) {
        float current = Math.abs((float) sizes.get(i).height / (float) sizes.get(i).width - (float) currentWidth / (float) currentHeight);
        if (current < min) {
            min = current;
            bestWidth = sizes.get(i).width;
            bestHeight = sizes.get(i).height;
        }
        i++;
    }
    int[] result = new int[2];
    result[0] = bestWidth;
    result[1] = bestHeight;
    Log.v("glcamera", bestWidth + "//" + bestHeight);
    return result;
}
```

6.设置拍照尺寸

```java
List<Camera.Size>sizes2 = parameters.getSupportedPictureSizes();
int[] result2 = getOptimalSize(sizes2,surfaceView.getWidth(),surfaceView.getHeight());
parameters.setPictureSize(result2[0],result2[1]);
```

7.设置视频的尺寸

```java
List<Camera.Size>sizes3 = parameters.getSupportedVideoSizes();
videoSizes=getOptimalSize(sizes3,surfaceView.getWidth(),surfaceView.getHeight());
mCamera.setParameters(parameters);
```

8,设置相机方向

```java
private void setCameraDisplayOrientation(int cameraId) {
    Activity targetActivity = (Activity) surfaceView.getContext();
    Camera.CameraInfo info =
            new Camera.CameraInfo();
    Camera.getCameraInfo(cameraId, info);
    int rotation = targetActivity.getWindowManager().getDefaultDisplay()
            .getRotation();
    int degrees = 0;
    switch (rotation) {
        case Surface.ROTATION_0:
            degrees = 0;
            break;
        case Surface.ROTATION_90:
            degrees = 90;
            break;
        case Surface.ROTATION_180:
            degrees = 180;
            break;
        case Surface.ROTATION_270:
            degrees = 270;
            break;
    }
    int result;
    if (info.facing == Camera.CameraInfo.CAMERA_FACING_FRONT) {
        result = (info.orientation + degrees) % 360;
        result = (360 - result) % 360;  // compensate the mirror
    } else {  // back-facing
        result = (info.orientation - degrees + 360) % 360;
    }
    mCamera.setDisplayOrientation(result);
    mOrientation = result;
}
```

10，预览

```java
try {
    mCamera.setPreviewDisplay(holder);
    mCamera.startPreview();
} catch (IOException e) {
    e.printStackTrace();
}
```

11.释放相机

```java
/**
 * 释放相机
 */
public void releaseCamera() {
    if (mCamera!=null){
        mCamera.stopPreview();
        //释放向机
        mCamera.release();
        mCamera = null;
    }
}
```

12.拍照

